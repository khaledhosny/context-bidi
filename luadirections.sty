\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luadirections}
    [2010/12/15 v0.002 Higher level interface to LuaTeX's multidirectional support]

\RequirePackage{luatexbase}

\directlua{
    bidi            = bidi or { }
    local chardata  = dofile(kpse.find_file("chardata.lua"))

    function bidi.get_direction(c)
        local dir = chardata[c] and chardata[c].direction or "l"
        return dir
    end

    function bidi.get_mirror(c)
       local mir = chardata[c] and chardata[c].mirror
       return mir
    end

    function bidi.set_mirror(c, m)
        if chardata[c] then
            chardata[c].mirror = m
        end
    end

    require("bidi")

    function bidi.enable()
       luatexbase.add_to_callback("pre_linebreak_filter", bidi.process, "BiDi processing (pre_line)", 1)
       luatexbase.add_to_callback("hpack_filter",         bidi.process, "BiDi processing (hpack)"   , 1)
    end

    function bidi.disable()
       luatexbase.remove_from_callback("pre_linebreak_filter", bidi.process, "BiDi processing (pre_line)")
       luatexbase.remove_from_callback("hpack_filter",         bidi.process, "BiDi processing (hpack)")
    end
}

\def\bidion{\directlua{bidi.enable()}}
\def\bidioff{\directlua{bidi.disable()}}

\endinput
