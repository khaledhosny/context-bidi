\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luadirections}
    [2010/03/24 v0.001 Higher level interface to LuaTeX's multidirectional support]

\RequirePackage{luatextra}

\newluatexattribute\bidiedir
\newluatexattribute\bidibdir
\newluatexattribute\bidilevel

\directlua{
    bidi            = bidi or { }
    bidi.attributes = {
        bidilevel   = tex.attributenumber["bidilevel"],
        bidbdir     = tex.attributenumber["bidibdir"],
        bidedir     = tex.attributenumber["bidiedir"],
    }

    bidi.chardata   = dofile(kpse.find_file("chardata.lua"))

    require("bidi")

    function bidi.enable()
       callback.add("pre_linebreak_filter", bidi.process, "bidi processing", 1)
       callback.add("hpack_filter",         bidi.process, "bidi processing", 1)
    end

    function bidi.disable()
       callback.remove("pre_linebreak_filter", bidi.process, "bidi processing")
       callback.remove("hpack_filter",         bidi.process, "bidi processing")
    end
}

\newcommand\bidion{\directlua{bidi.enable()}}
\newcommand\bidioff{\directlua{bidi.disable()}}

\bidion

\endinput
