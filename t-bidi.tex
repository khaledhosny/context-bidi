%D \module
%D   [     file=t-bidi,
%D      version=0.002,
%D        title=Bidi Processing,
%D     subtitle=Higher level interface to \LUATEX's bidirectional support,
%D       author=Khaled Hosny,
%D         date=\currentdate,
%D    copyright=Khaled Hosny,
%D      license=CC0]

\writestatus{loading}{Unicode Bidirectional Algorithm}

\startmodule[bidi]

\unprotect

\startluacode

bidi            = bidi or { }
bidi.chardata   = characters.data

function bidi.get_direction(c)
    local dir = bidi.chardata[c] and bidi.chardata[c].direction or "l"
    return dir
end

\stopluacode

\registerctxluafile{bidi}{0.002}

\startluacode

function bidi.enable()
    nodes.tasks.enableaction("processors", "bidi.process")
end

function bidi.disable()
    nodes.tasks.disableaction("processors", "bidi.process")
end

function bidi.setmaindir(dir)
    if dir == "r2l" then
        dir = "TRT"
    else
        dir = "TLT"
    end

    tex.sprint(tex.ctxcatcodes, [[\primitive\pagedir ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\bodydir ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\pardir  ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\textdir ]]..dir)
end

function bidi.setup(str)
    local settings = { }

    utilities.parsers.settings_to_hash(str, settings)

    for k,v in next, settings do
        if k == "main" then
            bidi.setmaindir(v)
        elseif k == "bidi" then
            if v == "on" then
                bidi.enable()
            elseif v == "off" then
                bidi.disable()
            end
        end
    end
end

nodes.tasks.appendaction("processors", "characters",  "bidi.process")

bidi.disable()

\stopluacode

\unexpanded\def\setupbidi
  {\dosingleargument\dosetupbidi}

\def\dosetupbidi[#1]%
  {\ctxlua{bidi.setup("#1")}}

\protect

\stopmodule

\doifnotmode{demo}{\endinput}

\usemodule[bidi]
\usemodule[simplefonts]

\setmainfont[dejavusans][features=arabic]
\setupbidi[bidi=on,main=r2l]

\starttext

\donknuthmode

\def\TEST{أبجد () هوز ab()cd حطي g كلمن ١٢٣٤٥ سعفص قرشت.}

\TEST

أبجد () هوز ab()cd حطي g كلمن {\textdir TRT ١٢٣٤٥} سعفص {\textdir TLT قرشت}.

\halign{\hfil\it # & # \hfil\cr
3 cl & \TEST\cr
2 cl & \TEST\cr
1.5 cl & \TEST\cr}

\stoptext
