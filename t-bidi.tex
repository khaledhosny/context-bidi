%D \module
%D   [     file=t-bidi,
%D      version=0.002,
%D        title=Bidi Processing,
%D     subtitle=Higher level interface to \LUATEX's bidirectional support,
%D       author=Khaled Hosny,
%D         date=\currentdate,
%D    copyright=Khaled Hosny,
%D      license=CC0]

\writestatus{loading}{Unicode Bidirectional Algorithm}

\startmodule[bidi]

\unprotect

\startluacode

bidi            = bidi or { }
bidi.attributes = {
    bidilevel   = attributes.private("bidilevel"),
    bidbdir     = attributes.private("bidibdir"),
    bidedir     = attributes.private("bidiedir"),
}

bidi.chardata   = characters.data

\stopluacode

\registerctxluafile{bidi}{0.002}

\startluacode

function bidi.enable()
    nodes.tasks.enableaction("processors", "bidi.handle_bidi")
end

function bidi.disable()
    nodes.tasks.disableaction("processors", "bidi.handle_bidi")
end

function bidi.setmaindir(dir)
    if dir == "r2l" then
        dir = "TRT"
    else
        dir = "TLT"
    end

    tex.sprint(tex.ctxcatcodes, [[\primitive\pagedir ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\bodydir ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\pardir  ]]..dir)
    tex.sprint(tex.ctxcatcodes, [[\primitive\textdir ]]..dir)
end

function bidi.setup(str)
    local settings = { }

    utilities.parsers.settings_to_hash(str, settings)

    for k,v in next, settings do
        if k == "main" then
            bidi.setmaindir(v)
        elseif k == "bidi" then
            if v == "on" then
                bidi.enable()
            elseif v == "off" then
                bidi.disable()
            end
        end
    end
end

nodes.tasks.appendaction("processors", "characters",  "bidi.process")

bidi.disable()

\stopluacode

\unexpanded\def\setupbidi
  {\dosingleargument\dosetupbidi}

\def\dosetupbidi[#1]%
  {\ctxlua{bidi.setup("#1")}}

\protect

\stopmodule

\doifnotmode{demo}{\endinput}

\usemodule[bidi]
\usemodule[simplefonts]

\setmainfont[dejavusans][features=arabic]
\setupbidi[bidi=on,main=r2l]

\starttext
أبجد () هوز ab()cd حطي g كلمن ١٢٣٤٥ سعفص قرشت.
\stoptext
