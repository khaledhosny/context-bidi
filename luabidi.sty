\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luabidi}
    [2010/12/15 v0.002 Higher level interface to LuaTeX's right-to-left support]

\RequirePackage{luatexbase}

\directlua{
    bidi            = bidi or { }
    local chardata  = dofile(kpse.find_file("chardata.lua"))

    function bidi.get_direction(c)
        local dir = chardata[c] and chardata[c].dir or "l"
        return dir
    end

    function bidi.get_mirror(c)
        local mir = chardata[c] and chardata[c].mir
        return mir
    end

    require("bidi")

    local function do_math(head, ...)
        head = node.mlist_to_hlist(head, ...)
        head = bidi.process_math(head)
        return head
    end

    luatexbase.add_to_callback("pre_linebreak_filter", bidi.process,           "BiDi processing (pre_line)", 1)
    luatexbase.add_to_callback("hpack_filter",         bidi.process,           "BiDi processing (hpack)",    1)
    luatexbase.add_to_callback("vpack_filter",         bidi.process_alignment, "BiDi processing (vpack)",    1)
    luatexbase.add_to_callback("mlist_to_hlist",       do_math,                "BiDi processing (math)",    1)
}

\endinput
